trigger:
  branches:
    include:
      - main

pool:
  name: mycomputeragent

variables:
  buildConfiguration: Release

# ================= BUILD STAGE =================
stages:
- stage: Build
  displayName: Build Stage
  jobs:
  - job: BuildJob
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: sdk
        version: 8.x

    - task: DotNetCoreCLI@2
      displayName: Restore
      inputs:
        command: restore
        projects: '**/*.csproj'

    - task: DotNetCoreCLI@2
      displayName: Build
      inputs:
        command: build
        projects: '**/*.csproj'
        arguments: '--configuration $(buildConfiguration)'

    - task: DotNetCoreCLI@2
      displayName: Publish
      inputs:
        command: publish
        publishWebProjects: true
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
        zipAfterPublish: true

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifact: drop

# ================= DEPLOY TO STAGING =================
- stage: Deploy_Staging
  displayName: Deploy to Staging
  dependsOn: Build
  jobs:
  - job: DeployStaging
    steps:
    - download: current
      artifact: drop

    - task: AzureWebApp@1
      displayName: Deploy to STAGING slot
      inputs:
        azureSubscription: AzureServiceConnection
        appType: webApp
        appName: dotnet-core-mvc
        slotName: staging
        package: '$(Pipeline.Workspace)/drop/**/*.zip'

# ================= DEPLOY TO PRODUCTION (APPROVAL) =================
- stage: Deploy_Production
  displayName: Deploy to Production
  dependsOn: Deploy_Staging

  jobs:
  - deployment: SwapSlots
    displayName: Swap Staging to Production
    environment: production   # üîê Approval happens here

    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureAppServiceManage@0
            displayName: Swap Staging to Production
            inputs:
              azureSubscription: AzureServiceConnection
              resourceGroupName: dotnet-core-mvc_group   # ‚úÖ REQUIRED
              action: Swap Slots
              webAppName: dotnet-core-mvc
              sourceSlot: staging
              targetSlot: production

